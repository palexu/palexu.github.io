<h2 id="基本">基本</h2>

<h3 id="server-以ubuntu为例">server, 以ubuntu为例</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 一键安装wireguard 脚本 Ubuntu</span>
<span class="c"># 该脚本由 https://github.com/hongwenjun 提供, 建议自行查看该脚本内容, 了解原理</span>
<span class="nv">$ </span>wget https://raw.githubusercontent.com/hongwenjun/vps_setup/master/ubuntu_wireguard_install.sh | bash
</code></pre></div></div>

<p>之后拷贝生成的 client.conf 内容</p>

<h3 id="client-以mac为例">client, 以mac为例</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install wireguard-tools
</code></pre></div></div>

<h2 id="udp加速">udp加速</h2>

<h3 id="server">server</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 一键安装 udp2raw/udpspeed &amp; kcptun</span>
<span class="c"># 该脚本由 https://github.com/hongwenjun 提供, 建议自行查看该脚本内容, 了解原理</span>
<span class="nv">$ </span>wget 
https://raw.githubusercontent.com/hongwenjun/WinKcp_Launcher/master/wg_udp2raw.sh | bash
</code></pre></div></div>

<p>安装完成后, 会输出如下内容:</p>

<blockquote>
  <p>请访问 https://git.io/winkcp 下载Windows客户端; https://git.io/sskcp.sh OpenWRT或KoolShar脚本
按以下实际信息填充    服务器IP: [服务器ip]
  WG+SPEED+UDP2RAW 原端口: 20713 ;  UDP2RAW伪装TCP后端口: 2999 ; 转发密码: 324f83
  SS+KCP+UDP2RAW加速: UDP2RAW伪装TCP后端口: 1999 ; SS密码: 324f83 加密协议 aes-256-gcm
  手机SS+KCP加速方案: KCPTUN端口: 4000 ; KCP插件设置参数 mode=fast2;key=324f83;mtu=1300</p>
</blockquote>

<h3 id="client">client</h3>

<p>下载 udp2raw 与 udpspeed</p>

<p>https://github.com/wangyu-/udp2raw-tunnel/releases</p>

<p>https://github.com/wangyu-/UDPspeeder/releases</p>

<p>其中, 可能需要安装额外的依赖, 参见:<a href="https://github.com/wangyu-/udp2raw-multiplatform/wiki/安装pcap和libnet">安装pcap和libnet</a></p>

<p>放置到/etc/wireguard目录</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/wireguard/udp2raw_mp <span class="nt">-c</span> <span class="nt">-l127</span>.0.0.1:20712 <span class="nt">-r155</span>.138.138.10:2999 <span class="nt">-k</span> 324f83 <span class="nt">--raw-mode</span> easy-faketcp

<span class="nb">sudo</span> /etc/wireguard/speederv2 <span class="nt">-c</span> <span class="nt">-l127</span>.0.0.1:20713 <span class="nt">-r127</span>.0.0.1:20712 <span class="nt">-k</span> 324f83 <span class="nt">-f20</span>:10 <span class="nt">--mode</span> 0

<span class="nb">sudo </span>wg-quick up wg1
</code></pre></div></div>

<p>todo: 可参考 https://github.com/atrandys/luci-udptools/blob/master/src/etc/init.d/udptools , 配置上面这两个命令的一键启动(未完成)</p>

<p>注意: 在wireguard中, endpoint的流量会走老的网关出去. 但是此时我们需要将endpoint指向127.0.0.1:20713(speederv2服务), 此时127.0.0.1的流量就会错误地走老的网关出去(而不是本机转发).</p>

<p><img src="/Users/xj/code/palexu.github.io/_posts/assets/image-20190611131545663.png" alt="image-20190611131545663" /></p>

<p>因此, 建议在 PostUp 里, 将 127.0.0.1 重新指向 -blackhole (或简单地直接移除 <code class="highlighter-rouge">route delete 127.0.0.1</code>)</p>

<p>wg1.conf</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">[Interface]</span>
<span class="py">PrivateKey</span> <span class="p">=</span> <span class="s">PRIVATE_KEY</span>
<span class="py">Address</span> <span class="p">=</span> <span class="s">10.0.0.2/24</span>
<span class="py">DNS</span> <span class="p">=</span> <span class="s">8.8.8.8</span>
<span class="py">MTU</span> <span class="p">=</span> <span class="s">1200</span>
<span class="py">PostUp</span> <span class="p">=</span> <span class="s">export PRIORITY=1024; source /etc/wireguard/udp-up</span>
<span class="py">PreDown</span> <span class="p">=</span> <span class="s">export PRIORITY=1024; source /etc/wireguard/udp-down</span>

<span class="err">[Peer]</span>
<span class="py">PublicKey</span> <span class="p">=</span> <span class="s">PUBLIC_KEY</span>
<span class="py">Endpoint</span> <span class="p">=</span> <span class="s">127.0.0.1:20713</span>
<span class="py">AllowedIPs</span> <span class="p">=</span> <span class="s">0.0.0.0/0, ::0/0</span>
<span class="py">PersistentKeepalive</span> <span class="p">=</span> <span class="s">25</span>
</code></pre></div></div>

<p>udp-up</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/bin:/sbin:/usr/sbin:/usr/bin"</span>

<span class="nv">OLDGW</span><span class="o">=</span><span class="sb">`</span>netstat <span class="nt">-nr</span> | <span class="nb">grep</span> <span class="s1">'^default'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'ppp'</span> | sed <span class="s1">'s/default *\([0-9\.]*\) .*/\1/'</span> | awk <span class="s1">'{if($1){print $1}}'</span><span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> /tmp/pptp_oldgw <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> /tmp/pptp_oldgw
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span>

dscacheutil <span class="nt">-flushcache</span>

route add 10.0.0.0/8 <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span>
route delete 127.0.0.1
route add &lt;YOU_SERVER_IP&gt; <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>udp-down</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c">#!/bin/sh</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/bin:/sbin:/usr/sbin:/usr/bin"</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-e</span> /tmp/pptp_oldgw <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">exit </span>0
<span class="k">fi

</span><span class="nv">OLDGW</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /tmp/pptp_oldgw<span class="sb">`</span>

route delete 10.0.0.0/8 <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span>
route delete 155.138.138.10 <span class="s2">"</span><span class="k">${</span><span class="nv">OLDGW</span><span class="k">}</span><span class="s2">"</span>

</code></pre></div></div>

<h2 id="客户端分流">客户端分流</h2>

<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1g3xa5q27nlj30lg0m1q41.jpg" alt="image-20190611141859385" /></p>

<p>分流主要依靠 chnroutes 项目实现, 参考<a href="https://github.com/zbinlin/wireguard-configuration/issues/1">wireguard-configuration: issue mac如何分流</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/wireguard
git clone https://github.com/fivesheep/chnroutes.git
<span class="nb">cd </span>chnroutes
./chnroutes <span class="nt">-p</span> mac
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PostUp = export PRIORITY=1024; source /etc/wireguard/ip-up
PreDown = export PRIORITY=1024; source /etc/wireguard/ip-down
</code></pre></div></div>

<h3 id="存在问题">存在问题</h3>
<h3 id="8888-覆盖了公司内网dns-导致内部网站无法访问">8.8.8.8 覆盖了公司内网dns, 导致内部网站无法访问</h3>

<h3 id="是否添加了公司内部的网关">是否添加了公司内部的网关</h3>

<h3 id="考虑udp2raw之后tcp阻断的替代方案">考虑udp2raw之后tcp阻断的替代方案</h3>

<h2 id="参考资料">参考资料</h2>

<ol>
  <li><a href="https://sskaje.me/2017/06/wireguard-wg-quick-postup的高级玩法/">WireGuard wg-quick PostUp的高级玩法</a></li>
  <li><a href="https://github.com/adrianmihalko/raspberrypiwireguard">树莓派上安装WireGuard</a></li>
  <li><a href="https://colin-chang.site/linux/part3/wg.html">下一代VPN协议 - WireGuard</a></li>
  <li><a href="https://blog.csdn.net/offbye/article/details/37871539">基于chnroutes实现的Mac下的VPN国内外网络分流技术</a></li>
  <li><a href="https://blog.mozcp.com/wireguard-usage/">WireGuard 配置和上网流量优化</a></li>
</ol>
