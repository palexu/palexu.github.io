<h2 id="原因">原因</h2>

<p>最近做的项目属于数据分析类型，要求数据分析功能做到快速上线。该项目当前使用的语言是Java + Groovy。 使用Groovy的原因很简单，因为 Groovy 脚本支持热加载功能。项目中，简单的数据分析工作，如一些统计、排序、过滤等，都放在Groovy里完成。需要上线新的数据分析功能时，只需要编写一个新的脚本，并热加载到JVM中即可。</p>

<p>现在希望将一些数据源访问、数据预处理的工作也放到 Groovy 脚本中完成,并具有这样的功能：项目在线上稳定运行期间，可以通过修改数据库中的脚本来完成新产品的上线。</p>

<h2 id="解决方案">解决方案</h2>

<ul>
  <li>PlanA: Java + 热加载</li>
  <li>PlanB: Groovy + 热加载</li>
</ul>

<p>最终选择的方案是PlanB：让 Groovy 脚本需要具有访问数据源、调用rpc服务等等的能力。核心思路是利用Spring对Groovy脚本进行管理。</p>

<ol>
  <li>Groovy 脚本保存在数据库中。定时任务不断轮训数据库检测Groovy脚本的更新时间，若有更新，则读取脚本内容，并解析为Class。</li>
  <li>然后利用Spring提供的工具类BeanDefinitionBuilder，生成BeanDefinition。BeanDefinition中保存了Groovy脚本的meta信息，比如对其他类的依赖。</li>
  <li>接着，将BeanDefinition放入Spring上下文ApplicationContext中，并调用初始化方法，对bean进行依赖注入。</li>
  <li>最后，调用context.getBean(“xxx”)拿到该脚本。</li>
</ol>

<p>当然，需要注意的细节有很多，比如服务降级、安全控制等，这里就不展开说了。</p>

<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fte784mbcbj30hb0fvq2y.jpg" alt="架构简图" /></p>

<h2 id="简单实现">简单实现</h2>

<p>Hello.groovy
这是保存在数据库中的Groovy脚本。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span>

<span class="kd">class</span> <span class="nc">Hello</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">HelloService</span> <span class="n">service</span><span class="o">;</span>

    <span class="n">HelloService</span> <span class="nf">getService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">service</span>
    <span class="o">}</span>

    <span class="n">def</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">print</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">hello</span><span class="o">())</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>HelloService.java
这是项目中已经提供的服务，现实项目中可以是访问数据源等功能。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"now hello"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>第一步，需要拿到Spring上下文 ApplicationContext。这个有很多种实现，比如继承ApplicationContextAware接口等。</p>

<p>第二步，获取到编译后的脚本，如下。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//从数据库中获取到脚本内容</span>
<span class="n">String</span> <span class="n">scriptContent</span> <span class="o">=</span> <span class="s">"......"</span><span class="o">;</span>
<span class="c1">//编译</span>
<span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroovyClassLoader</span><span class="o">().</span><span class="na">parseClass</span><span class="o">(</span><span class="n">scriptContent</span><span class="o">);</span>
</code></pre></div></div>

<p>第三步，将bean放入上下文，并进行依赖注入</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BeanDefinitionBuilder</span> <span class="n">beanDefinitionBuilder</span> <span class="o">=</span> <span class="n">BeanDefinitionBuilder</span><span class="o">.</span><span class="na">genericBeanDefinition</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
<span class="n">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">beanDefinitionBuilder</span><span class="o">.</span><span class="na">getRawBeanDefinition</span><span class="o">();</span>
<span class="n">context</span><span class="o">.</span><span class="na">getAutowireCapableBeanFactory</span><span class="o">().</span><span class="na">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">,</span> <span class="s">"hello"</span><span class="o">);</span>
<span class="n">beanFactory</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="s">"hello"</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
</code></pre></div></div>

<p>第四步，从上下文中获取Groovy脚本</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hello</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
<span class="n">hello</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="c1">//console中应当输出下面内容,此时说明HelloService已经成功注入到groovy脚本中了</span>
<span class="c1">//now hello</span>
</code></pre></div></div>
<hr />

<h2 id="参考资料">参考资料</h2>
<ol>
  <li><a href="https://www.ibm.com/developerworks/cn/java/j-groovierspring2.html">Groovy 使 Spring 更出色，第 2 部分 - 在运行时改变应用程序的行为 - 用 Groovy 为 Spring 应用程序添加可动态刷新的 bean</a></li>
  <li><a href="https://blog.csdn.net/chao_1990/article/details/77370314">动态注入 Bean 到 Spring 容器</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/30226423">spring 动态注册 bean 王雁</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/30070328">Spring 动态注册 bean 李佳明</a></li>
</ol>
