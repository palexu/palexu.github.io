<p>拓扑会通过 Nimbus 分发给 supervisor, 那么 Nimbus 内部是怎么操作的?
这里以本地模式为例, 对拓扑的提交过程做一个分析.</p>

<p>参考资料:
<a href="https://meta.tn/a/4dd64fdd491b30afba2893e0a570ca8eb8fc1bfb21ccb8d8f8f44cbdc2bb6be4">理解storm拓扑并行度</a></p>

<h2 id="疑问">疑问:</h2>

<ol>
  <li>在zk上建立task信息,这些信息是用来做什么的?</li>
  <li>notifyTopologyActionListener 做了什么?</li>
</ol>

<h2 id="启动">启动</h2>

<p>TODO …</p>

<h2 id="命令的入口">命令的入口</h2>

<p>所有命令的入口, 都是由 ServiceHandler 实现的,  com.alibaba.jstorm.daemon.nimbus.ServiceHandler#submitTopologyWithOpts.</p>

<ol>
  <li>配置校验</li>
  <li>判断拓扑是否已存在/重名/重复提交</li>
  <li>标准化conifg</li>
  <li>标准化topology (finalize component’s task parallism)</li>
  <li>校验topology结构
    <ol>
      <li>校验 bolt/spout 的id 和 name</li>
      <li>校验 bolt 的输入是否为空</li>
    </ol>
  </li>
  <li>拷贝代码二进制文件到集群</li>
  <li>在zk上建立task信息 (supervisor会持续监控保存在zk的任务)
 <img src="https://ws2.sinaimg.cn/large/006tNc79ly1fzartnvu25j31em04i0to.jpg" alt="F7A5DEAE-BED4-4A4E-8EB9-1E4DD9726223" />
    <ol>
      <li>为bolt/spout等创建对应的 TaskInfo (多并行度的bolt/spout会创建出多个TaskInfo)
 com.alibaba.jstorm.cluster.Common#mkTaskMaker</li>
      <li>注意, jstorm 的 setNumTasks 其实是无效的, 只有 paralleism 并行度会起作用.(见 jstorm作者之一cody的回答: https://stackoverflow.com/a/34316700/6275014 )</li>
    </ol>
  </li>
  <li>StartTopologyEvent.pushEvent,
    <ol>
      <li>然后会异步地去执行 com.alibaba.jstorm.daemon.nimbus.TopologyAssign#mkAssignment
        <ol>
          <li>com.alibaba.jstorm.schedule.default_assign.TaskScheduler#assign:
 将task分配给worker, 在这里做了一些定制化, 如有的task要求分配在不同的worker上等.</li>
          <li>创建好 Assign 后, 会发布到 zk 上.</li>
        </ol>
      </li>
    </ol>
  </li>
  <li>notifyTopologyActionListener</li>
</ol>

